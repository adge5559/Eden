{{> head}}

{{!-- TODO: --}}

<div class="container">
    <div class="post-image">
        <img src="{{post.titleimagepath}}" alt="{{post.title}}" class="title-image" style="max-width: 100%; height: auto; max-height: 400px;">
    </div>
    <h2>{{post.title}}</h2>
  
  <!-- Hardcoded Box with plant image and description -->
    <div class="post-container">
        <!-- Other post details here -->
        <div class="info-box">
            {{!-- Link to author's profile --}}
            <p>
                Posted by: 
                <a href="/user/{{user.username}}" class="profile-link" style="text-decoration: none; color: inherit;">
                    <img src="{{user.profilepicture}}" alt="Profile Picture" class="profile-icon" style="width: 24px; height: 24px; border-radius: 50%; vertical-align: middle; margin-right: 5px;">
                    <strong>{{user.username}}</strong>
                </a>
            </p>
            <p>
                Created on: 
                <small>{{post.formattedCreateTime}}</small>
            </p>
        </div>

        <div class="post-content">
            {{#each sections}}
                <h5>{{this.sectiontitle}}</h5>
                <img src="{{this.imgpath}}" alt="{{this.sectiontitle}}" class="section-image" style="max-width: 100%; height: auto; max-height: 200px;">
                <p>{{this.content}}</p>
            {{/each}}
        </div>

        {{!-- TODO: Tags --}}

        {{!-- Like --}}
        <div class="like-section">
            <button class="like-button" data-post-id="{{post.postid}}">üëç Like</button>
            <span class="like-count" id="like-count-{{post.postid}}">{{post.likes}} Likes</span>

        </div>

        <!-- Comments Section -->
        <div class="comments-section">
            <h4>Comments</h4>
            {{!-- TODO: insert not working --}}
            <div class="comment-input-section">
                <input type="text" id="comment-input" placeholder="Write a comment..." required class="comment-input">
                <button id="comment-submit-btn" data-post-id="{{post.postid}}">Post Comment</button>
            </div>

            <div id="comments-list">
                {{#each comments}}
                    <div class="comment-box">
                        <p>
                            <a href="/user/{{this.username}}" class="profile-link" style="text-decoration: none; color: inherit;">
                                <strong>{{this.username}}</strong>
                            </a>
                            <small>{{this.formattedCreateTime}}</small>
                        </p>
                        <p class="comment-text">{{this.commenttext}}</p>
                    </div>
                {{/each}}
            </div>
        </div>
    </div>
</div>


{{> message}}
{{> footer}}


{{!-- JS for Like Button --}}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Like Listener
        const likeButton = document.querySelector('.like-button');
        const postId = likeButton.getAttribute('data-post-id');
        const likecount = document.getElementById(`like-count-${postId}`);
        
        likeButton.addEventListener('click', async function(event) {
            event.preventDefault();
            try {
                const response = await fetch(`/post/${postId}/like`, {method: 'POST'});
                const result = await response.json();

                if (response.ok) {
                    likecount.textContent = `${result.likes} Likes`;
                } else {
                    console.error('Failed to like the post');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        });

        // Comment Listener
        const commentSubmitButton = document.getElementById('comment-submit-btn');
        const commentInput = document.getElementById('comment-input');
        const commentsList = document.getElementById('comments-list');

        commentSubmitButton.addEventListener('click', async function(event) {
            event.preventDefault();

            const commentText = commentInput.value.trim();
            // Return if empty
            if (!commentText) return;

            try {
                const response = await fetch(`/post/${postId}/comment`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({commentText})
                });

                if (response.ok) {
                    const result = await response.json();

                    // Clear input field and display new comments
                    commentInput.value = '';
                    const newComment = document.createElement('div');
                    newComment.className = 'comment-box';
                    newComment.innerHTML = `
                        <p>
                            <a href="/user/${result.username}" class="profile-link" style="text-decoration: none; color: inherit;">
                                <strong>${result.username}</strong>
                            </a>
                            <small>${result.formattedCreateTime}</small>
                        </p>
                        <p class="comment-text">${result.commenttext}</p>
                    `;
                    commentsList.appendChild(newComment);
                } else {
                    console.error('Failed to post comment');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        });
    });
</script>
